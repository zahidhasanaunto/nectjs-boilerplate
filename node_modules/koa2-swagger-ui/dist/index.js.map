{"version":3,"file":"index.js","sourceRoot":"","sources":["../lib/index.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport Handlebars from 'handlebars';\nimport { defaultsDeep } from 'lodash';\nimport path from 'path';\nimport readPkgUp from 'read-pkg-up';\nimport { Context, Middleware } from 'koa';\n\nexport interface SwaggerOptions {\n  [key: string]: string | boolean | string[] | object;\n  // eslint-disable-next-line @typescript-eslint/camelcase\n  dom_id: string;\n  url: string;\n  supportedSubmitMethods: string[];\n  docExpansion: string;\n  jsonEditor: boolean;\n  defaultModelRendering: string;\n  showRequestHeaders: boolean;\n  layout: string;\n  spec: object;\n}\n\nexport interface KoaSwaggerUiOptions {\n  title: string;\n  oauthOptions: boolean | any;\n  swaggerOptions: Partial<SwaggerOptions>;\n  swaggerVersion: string;\n  routePrefix: string | false;\n  hideTopbar: boolean;\n  favicon16: string;\n  favicon32: string;\n}\n\nconst defaultOptions: KoaSwaggerUiOptions = {\n  title: 'Swagger UI',\n  oauthOptions: false,\n  swaggerOptions: {\n    // eslint-disable-next-line @typescript-eslint/camelcase\n    dom_id: '#swagger-ui',\n    url: 'https://petstore.swagger.io/v2/swagger.json',\n    layout: 'StandaloneLayout',\n  },\n  routePrefix: '/docs',\n  swaggerVersion: '',\n  hideTopbar: false,\n  favicon16: '/favicon-16x16.png',\n  favicon32: '/favicon-32x32.png',\n};\n\nfunction koaSwagger(config: Partial<KoaSwaggerUiOptions> = {}): Middleware {\n  if (config.swaggerVersion === undefined) {\n    const pkg = readPkgUp.sync({ cwd: __dirname });\n    if (pkg === undefined) {\n      throw new Error('Package not found');\n    }\n\n    defaultOptions.swaggerVersion = pkg.packageJson.devDependencies!['swagger-ui-dist'];\n  }\n\n  // Setup icons\n  const extFavicon16 = config.favicon16;\n  const extFavicon32 = config.favicon32;\n  const favicon16Path = path.join(__dirname, defaultOptions.favicon16);\n  const favicon32Path = path.join(__dirname, defaultOptions.favicon32);\n\n  // Setup default options\n  const options = defaultsDeep(config, defaultOptions);\n  Handlebars.registerHelper('json', context => JSON.stringify(context));\n  Handlebars.registerHelper('strfnc', fnc => fnc);\n  Handlebars.registerHelper('isset', function (this: any, conditional: any, opt) {\n    return conditional ? opt.fn(this) : opt.inverse(this);\n  });\n  const index = Handlebars.compile(fs.readFileSync(path.join(__dirname, './index.hbs'), 'utf-8'));\n\n  // eslint-disable-next-line func-names\n  return function koaSwaggerUi(ctx: Context, next: any) {\n    if (options.routePrefix === false || ctx.path === options.routePrefix) {\n      ctx.type = 'text/html';\n      ctx.body = index(options);\n      return true;\n    }\n\n    if (extFavicon16 === undefined && ctx.path === defaultOptions.favicon16) {\n      ctx.type = 'image/png';\n      ctx.body = fs.createReadStream(favicon16Path);\n      return true;\n    }\n\n    if (extFavicon32 === undefined && ctx.path === defaultOptions.favicon32) {\n      ctx.type = 'image/png';\n      ctx.body = fs.createReadStream(favicon32Path);\n      return true;\n    }\n\n    return next();\n  };\n}\n\nexport default koaSwagger;\nmodule.exports = koaSwagger;\n"]}